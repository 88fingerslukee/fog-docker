<VirtualHost *:{{FOG_APACHE_PORT}}>
    ServerName fog-server
    DocumentRoot /var/www/html
    
    # Directory settings
    <Directory /var/www/html>
        DirectoryIndex index.php index.html index.htm
        AllowOverride All
        Require all granted
    </Directory>
    
    # PHP configuration
    <FilesMatch "\.php$">
        SetHandler application/x-httpd-php
    </FilesMatch>
    
    # PHP session configuration
    php_value session.save_handler files
    php_value session.save_path "/var/lib/php/sessions"
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 0
    php_value session.use_strict_mode 1
    
    # FOG API rewrite rules - only for API calls, not management interface
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]
    
    # Redirect root to FOG management interface, preserving protocol if behind a proxy
    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} =https
    RewriteRule ^/$ https://%{HTTP_HOST}/fog/ [R=301,L]
    RewriteCond %{HTTP:X-Forwarded-Proto} !=https
    RewriteRule ^/$ http://%{HTTP_HOST}/fog/ [R=301,L]
    
    # Only redirect API calls to the API handler
    RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
    RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-d
    RewriteRule ^/fog/api/(.*)$ /fog/api/index.php [QSA,L]
    
    # Logging
    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost> 