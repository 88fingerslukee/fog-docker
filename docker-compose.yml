services:
  # Internal MySQL database
  fog-db:
    image: "mysql:8.0"
    container_name: fog-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${FOG_DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${FOG_DB_NAME:-fog}"
      MYSQL_USER: "${FOG_DB_USER:-fogmaster}"
      MYSQL_PASSWORD: "${FOG_DB_PASS:-fogmaster123}"
    volumes:
      - "fog_db:/var/lib/mysql:rw"
    networks:
      - fog_network
    command: --default-authentication-plugin=mysql_native_password

  fog-server:
    build:
      context: .
      args:
        FOG_GIT_URL: "${FOG_GIT_URL:-https://github.com/FOGProject/fogproject.git}"
        FOG_GIT_REF: "${FOG_VERSION:-stable}"
    container_name: fog-server
    restart: unless-stopped
    ports:
      - "${FOG_APACHE_EXPOSED_PORT:-80}:${FOG_APACHE_PORT:-80}"
      - "${FOG_APACHE_EXPOSED_SSL_PORT:-443}:${FOG_APACHE_SSL_PORT:-443}"
      - "69:69/udp"
      - "2049:2049"
      - "21:21"
    environment:
      # Database Configuration
      FOG_DB_HOST: "fog-db"
      FOG_DB_PORT: "3306"
      FOG_DB_NAME: "${FOG_DB_NAME:-fog}"
      FOG_DB_USER: "${FOG_DB_USER:-fogmaster}"
      FOG_DB_PASS: "${FOG_DB_PASS:-fogmaster123}"
      
      # Network Configuration
      FOG_WEB_HOST: "${FOG_WEB_HOST}"
      FOG_WEB_ROOT: "${FOG_WEB_ROOT:-/fog}"
      FOG_TFTP_HOST: "${FOG_TFTP_HOST:-localhost}"
      FOG_NFS_HOST: "${FOG_NFS_HOST:-localhost}"
      FOG_WOL_HOST: "${FOG_WOL_HOST:-localhost}"
      FOG_MULTICAST_INTERFACE: "${FOG_MULTICAST_INTERFACE:-eth0}"
      
      # Apache Configuration
      FOG_APACHE_PORT: "${FOG_APACHE_PORT:-80}"
      FOG_APACHE_SSL_PORT: "${FOG_APACHE_SSL_PORT:-443}"
      FOG_HTTPS_ENABLED: "${FOG_HTTPS_ENABLED:-false}"
      
      # FTP Configuration
      FOG_FTP_USER: "${FOG_FTP_USER:-fogproject}"
      FOG_FTP_PASS: "${FOG_FTP_PASS:-fogftp123}"
      
      # SSL Configuration
      FOG_SSL_PATH: "/opt/fog/snapins/ssl"
      FOG_SSL_CERT_FILE: "${FOG_SSL_CERT_FILE:-server.crt}"
      FOG_SSL_KEY_FILE: "${FOG_SSL_KEY_FILE:-server.key}"
      FOG_SSL_GENERATE_SELF_SIGNED: "${FOG_SSL_GENERATE_SELF_SIGNED:-true}"
      FOG_SSL_CN: "${FOG_SSL_CN:-${FOG_WEB_HOST}}"
      FOG_SSL_SAN: "${FOG_SSL_SAN:-}"
      
      # Secure Boot Configuration
      FOG_SECURE_BOOT_ENABLED: "${FOG_SECURE_BOOT_ENABLED:-false}"
      FOG_SECURE_BOOT_KEYS_DIR: "${FOG_SECURE_BOOT_KEYS_DIR:-/opt/fog/secure-boot/keys}"
      FOG_SECURE_BOOT_CERT_DIR: "${FOG_SECURE_BOOT_CERT_DIR:-/opt/fog/secure-boot/certs}"
      FOG_SECURE_BOOT_SHIM_DIR: "${FOG_SECURE_BOOT_SHIM_DIR:-/opt/fog/secure-boot/shim}"
      FOG_SECURE_BOOT_MOK_IMG: "${FOG_SECURE_BOOT_MOK_IMG:-/opt/fog/secure-boot/mok-certs.img}"
      
      # DHCP Configuration
      FOG_DHCP_ENABLED: "${FOG_DHCP_ENABLED:-false}"
      FOG_DHCP_START_RANGE: "${FOG_DHCP_START_RANGE:-192.168.1.100}"
      FOG_DHCP_END_RANGE: "${FOG_DHCP_END_RANGE:-192.168.1.200}"
      FOG_DHCP_BOOTFILE: "${FOG_DHCP_BOOTFILE:-undionly.kpxe}"
      FOG_DHCP_DNS: "${FOG_DHCP_DNS:-8.8.8.8}"
      
      # FOG Version
      FOG_VERSION: "${FOG_VERSION:-stable}"
      
      # Data Directory
      FOG_DATA_DIR: "${FOG_DATA_DIR:-/data}"
      
      # Timezone
      TZ: "${TZ:-UTC}"
      
      # Debug
      DEBUG: "${DEBUG:-false}"
      FORCE_FIRST_START_INIT: "${FORCE_FIRST_START_INIT:-false}"
    volumes:
      # FOG Images (main storage - matches bare metal /images)
      - "fog_images:/data/images:rw"
      
      # TFTP Boot files (matches bare metal /tftpboot)
      - "fog_tftpboot:/data/tftpboot:rw"
      
      # FOG Snapins (matches bare metal /opt/fog/snapins)
      - "fog_snapins:/data/snapins:rw"
      
      # FOG Logs (matches bare metal /opt/fog/log)
      - "fog_logs:/data/logs:rw"
      
      # FOG Configuration (persistent config files)
      - "fog_config:/data/config:rw"
      
      # SSL Certificates (matches bare metal /opt/fog/snapins/ssl)
      - "fog_ssl:/data/ssl:rw"
      
      # Secure Boot files (if enabled)
      - "fog_secure_boot:/data/secure-boot:rw"
      
      # Uncomment the following lines to mount external directories
      # - "/path/to/your/images:/data/images:rw"
      # - "/path/to/your/tftpboot:/data/tftpboot:rw"
      # - "/path/to/your/snapins:/data/snapins:rw"
      # - "/path/to/your/ssl/certificates:/data/ssl:ro"
    networks:
      - fog_network
    depends_on:
      - fog-db
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN

volumes:
  # Internal database volume
  fog_db:
    driver: local
  
  # FOG Images storage (main data directory)
  fog_images:
    driver: local
  
  # TFTP Boot files
  fog_tftpboot:
    driver: local
  
  # FOG Snapins
  fog_snapins:
    driver: local
  
  # FOG Logs
  fog_logs:
    driver: local
  
  # FOG Configuration
  fog_config:
    driver: local
  
  # SSL Certificates
  fog_ssl:
    driver: local
  
  # Secure Boot files
  fog_secure_boot:
    driver: local

networks:
  fog_network:
    driver: bridge
