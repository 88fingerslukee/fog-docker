services:
  # Database - Core data storage
  fog-db:
    image: mariadb:latest
    container_name: fog-db
    restart: unless-stopped
    network_mode: host
    environment:
      - MARIADB_ROOT_PASSWORD=${FOG_DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${FOG_DB_NAME}
      - MARIADB_USER=${FOG_DB_USER}
      - MARIADB_PASSWORD=${FOG_DB_PASS}
      - MARIADB_TCP_PORT=${FOG_DB_PORT}
    volumes:
      # Use named Docker volume by default, uncomment below for custom path
      - fog_mysql:/var/lib/mysql
      # - ${FOG_MYSQL_PATH}:/var/lib/mysql
      
  # FOG Server - Web interface + background services
  fog-server:
    build: 
      context: ./config/server
      args:
        - FOG_VERSION=${FOG_VERSION:-stable}
    container_name: fog-server
    restart: unless-stopped
    privileged: true
    network_mode: host
    depends_on: 
      - fog-db
    environment:
      - TZ=${TZ}
      - FOG_WEB_HOST=${FOG_WEB_HOST}
      - FOG_DB_HOST=${FOG_DB_HOST}
      - FOG_DB_PORT=${FOG_DB_PORT}
      - FOG_DB_ROOT_PASS=${FOG_DB_ROOT_PASS}
      - FOG_DB_NAME=${FOG_DB_NAME}
      - FOG_DB_USER=${FOG_DB_USER}
      - FOG_DB_PASS=${FOG_DB_PASS}
      - FOG_WEB_ROOT=${FOG_WEB_ROOT}
      - FOG_APACHE_PORT=${FOG_APACHE_PORT}
      - FOG_APACHE_SSL_PORT=${FOG_APACHE_SSL_PORT}
      - FOG_TFTP_HOST=${FOG_TFTP_HOST}
      - FOG_BOOTFILENAME=${FOG_BOOTFILENAME}
      - FOG_FTP_USER=${FOG_FTP_USER}
      - FOG_FTP_PASS=${FOG_FTP_PASS}
      - FOG_ADMIN_USER=${FOG_ADMIN_USER}
      - FOG_ADMIN_PASS=${FOG_ADMIN_PASS}
      - FOG_SSL_PATH=${FOG_SSL_PATH}
      - FOG_HTTPS_ENABLED=${FOG_HTTPS_ENABLED}
      - FOG_SSL_CERT_FILE=${FOG_SSL_CERT_FILE}
      - FOG_SSL_KEY_FILE=${FOG_SSL_KEY_FILE}
      - FOG_SSL_GENERATE_SELF_SIGNED=${FOG_SSL_GENERATE_SELF_SIGNED}
      - FOG_SSL_CN=${FOG_SSL_CN}
      - FOG_SSL_SAN=${FOG_SSL_SAN}
      - FOG_IPXE_PROTOCOL=${FOG_IPXE_PROTOCOL}
      - FOG_MULTICAST_INTERFACE=${FOG_MULTICAST_INTERFACE}
      - FOG_VERSION=${FOG_VERSION}
    volumes:
      # Use named Docker volumes by default, uncomment below for custom paths
      - fog_images:/images
      - fog_tftpboot:/tftpboot
      - fog_snapins:/opt/fog/snapins
      - fog_logs:/opt/fog/logs
      - fog_ssl:/opt/fog/snapins/ssl
      # - ${FOG_IMAGES_PATH}:/images
      # - ${FOG_TFTP_PATH}:/tftpboot
      # - ${FOG_SNAPINS_PATH}:/opt/fog/snapins
      # - ${FOG_LOGS_PATH}:/opt/fog/logs
      # - ${FOG_SSL_PATH}:/opt/fog/snapins/ssl
      
  fog-tftp:
    image: docker.io/kalaksi/tftpd:latest
    container_name: fog-tftp
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ}
      # An interface and a port to listen to. "0.0.0.0" means all interfaces
      - TFTPD_BIND_ADDRESS=0.0.0.0:69
      # Search the man page for --blocksize to learn more
      - TFTPD_EXTRA_ARGS=--blocksize 1468
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - SYS_CHROOT
      - NET_BIND_SERVICE
    volumes:
      # Use named Docker volume by default, uncomment below for custom path
      - fog_tftpboot:/tftpboot
      # - ${FOG_TFTP_PATH}:/tftpboot
      
  # NFS - Image file access (prebuilt)
  fog-nfs:
    image: erichough/nfs-server:latest
    container_name: fog-nfs
    restart: unless-stopped
    privileged: true
    network_mode: host
    environment:
      - TZ=${TZ}
      - NFS_EXPORT_0=/images *(rw,sync,no_subtree_check,no_root_squash,insecure,fsid=0)
      - NFS_EXPORT_1=/images/dev *(rw,async,no_wdelay,no_subtree_check,no_root_squash,insecure,fsid=1)
    volumes:
      # Use named Docker volume by default, uncomment below for custom path
      - fog_images:/images
      # - ${FOG_IMAGES_PATH}:/images
      
  # FTP - File transfers (prebuilt)
  fog-ftp:
    image: stilliard/pure-ftpd:latest
    container_name: fog-ftp
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ}
      - PUBLICHOST=${FOG_HOST_IP}
      - FTP_USER_NAME=${FOG_USERNAME}
      - FTP_USER_PASS=${FOG_FTP_PASS}
      - FTP_USER_HOME=/images
    volumes:
      # Use named Docker volume by default, uncomment below for custom path
      - fog_images:/images
      # - ${FOG_IMAGES_PATH}:/images

# Named Docker volumes for persistent storage
# These volumes are automatically created by Docker if they don't exist
volumes:
  fog_mysql:
    driver: local
  fog_images:
    driver: local
  fog_tftpboot:
    driver: local
  fog_snapins:
    driver: local
  fog_logs:
    driver: local
  fog_ssl:
    driver: local
