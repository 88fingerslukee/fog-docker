name: FOG Release Trigger

on:
  schedule:
    # Check for new FOG releases every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      fog_version:
        description: 'FOG version to build (e.g., stable, dev-branch, or specific version)'
        required: false
        default: 'stable'

jobs:
  check-fog-releases:
    runs-on: ubuntu-latest
    outputs:
      new-release: ${{ steps.check.outputs.new-release }}
      fog-version: ${{ steps.check.outputs.fog-version }}
    steps:
    - name: Check for new FOG releases
      id: check
      run: |
        # Get the latest FOG release
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          FOG_VERSION="${{ github.event.inputs.fog_version }}"
        else
          FOG_VERSION="stable"
        fi
        
        # Get the latest release tag from FOG repository with error handling
        if [ "$FOG_VERSION" = "stable" ]; then
          # Fetch with retry logic and error handling
          API_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.github.com/repos/FOGProject/fogproject/releases/latest)
          HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
          API_BODY=$(echo "$API_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: GitHub API returned HTTP $HTTP_CODE"
            echo "Response: $API_BODY"
            exit 1
          fi
          
          # Validate JSON before parsing
          if ! echo "$API_BODY" | jq empty 2>/dev/null; then
            echo "Error: Invalid JSON response from GitHub API"
            echo "Response: $API_BODY"
            exit 1
          fi
          
          LATEST_TAG=$(echo "$API_BODY" | jq -r '.tag_name // empty')
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: Could not extract tag_name from API response"
            echo "Response: $API_BODY"
            exit 1
          fi
        else
          LATEST_TAG="$FOG_VERSION"
        fi
        
        echo "Checking FOG version: $LATEST_TAG"
        
        # Check if we already have this version with error handling
        TAGS_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.github.com/repos/88fingerslukee/fog-docker/tags)
        TAGS_HTTP_CODE=$(echo "$TAGS_RESPONSE" | tail -n1)
        TAGS_BODY=$(echo "$TAGS_RESPONSE" | sed '$d')
        
        if [ "$TAGS_HTTP_CODE" != "200" ]; then
          echo "Warning: GitHub API returned HTTP $TAGS_HTTP_CODE when checking existing tags"
          echo "Assuming new release to be safe"
          EXISTING_TAGS=""
        else
          # Validate JSON before parsing
          if echo "$TAGS_BODY" | jq empty 2>/dev/null; then
            EXISTING_TAGS=$(echo "$TAGS_BODY" | jq -r '.[].name' | grep "fog-$LATEST_TAG" || echo "")
          else
            echo "Warning: Invalid JSON response when checking existing tags"
            echo "Assuming new release to be safe"
            EXISTING_TAGS=""
          fi
        fi
        
        # Validate the tag name before proceeding
        if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ] || [ "$LATEST_TAG" = "null\n" ]; then
          echo "Error: Invalid FOG version detected: '$LATEST_TAG'"
          echo "Cannot proceed with null or empty version"
          exit 1
        fi
        
        # Additional validation: ensure tag doesn't contain invalid characters
        if echo "$LATEST_TAG" | grep -qE '[^a-zA-Z0-9._-]'; then
          echo "Error: FOG version contains invalid characters: '$LATEST_TAG'"
          exit 1
        fi
        
        if [ -z "$EXISTING_TAGS" ]; then
          echo "New FOG release found: $LATEST_TAG"
          echo "new-release=true" >> $GITHUB_OUTPUT
          echo "fog-version=$LATEST_TAG" >> $GITHUB_OUTPUT
        else
          echo "FOG version $LATEST_TAG already exists"
          echo "new-release=false" >> $GITHUB_OUTPUT
          echo "fog-version=$LATEST_TAG" >> $GITHUB_OUTPUT
        fi

  build-and-push:
    needs: check-fog-releases
    if: needs.check-fog-releases.outputs.new-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set FOG version
      id: fog-version
      run: |
        FOG_VERSION="${{ needs.check-fog-releases.outputs.fog-version }}"
        
        # Validate version - fail if null or empty (should have been caught earlier, but double-check)
        if [ -z "$FOG_VERSION" ] || [ "$FOG_VERSION" = "null" ] || [ "$FOG_VERSION" = "null\n" ]; then
          echo "Error: FOG version is null or empty. Cannot build image."
          echo "This should not happen if the check step passed validation."
          exit 1
        fi
        
        # Validate tag name doesn't contain invalid characters
        if echo "$FOG_VERSION" | grep -qE '[^a-zA-Z0-9._-]'; then
          echo "Error: FOG version contains invalid characters: '$FOG_VERSION'"
          exit 1
        fi
        
        echo "fog-version=$FOG_VERSION" >> $GITHUB_OUTPUT
        echo "Building with FOG version: $FOG_VERSION"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/88fingerslukee/fog-docker
        tags: |
          type=raw,value=fog-${{ steps.fog-version.outputs.fog-version }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          FOG_GIT_REF=${{ steps.fog-version.outputs.fog-version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: fog-${{ steps.fog-version.outputs.fog-version }}
        release_name: FOG Docker ${{ steps.fog-version.outputs.fog-version }}
        body: |
          This release contains FOG Docker image built with FOG Project version ${{ steps.fog-version.outputs.fog-version }}.

          ## What's New
          - Updated to FOG Project ${{ steps.fog-version.outputs.fog-version }}
          - All previous features and improvements included
          
          ## Documentation
          - [Full README](https://github.com/88fingerslukee/fog-docker/blob/main/README.md)
          - [Configuration Guide](https://github.com/88fingerslukee/fog-docker/blob/main/.env.example)
          - [FOG Project Documentation](https://wiki.fogproject.org/)
          
          ## Full Changelog
          See the [FOG Project releases](https://github.com/FOGProject/fogproject/releases) for detailed changelog.
        draft: false
        prerelease: false
